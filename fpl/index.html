<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<title>Hannes Gebhard's eliteleague FPL Dashboard</title>
		<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
		<link
			rel="stylesheet"
			href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"
		/>
		<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

		<style>
			body {
				font-family: Arial, sans-serif;
				margin: 20px;
			}
			#player-select {
				min-width: 250px;
				margin-bottom: 20px;
			}
		</style>
	</head>
	<body>
		<h1>Hannes Gebhard's eliteleague FPL Dashboard</h1>

		<label for="player-select">Select Players:</label>
		<select id="player-select" multiple></select>

		<h2>Weekly Points</h2>
		<div id="weekly-plot" style="width: 100%; height: 500px"></div>

		<h2>Cumulative Points</h2>
		<div id="cumulative-plot" style="width: 100%; height: 500px"></div>

		<script>
			async function initDashboard() {
				const resp = await fetch("fpldata.json");
				const data = await resp.json();

				const players = [...new Set(data.map((d) => d.player))];
				const select = document.getElementById("player-select");

				// Populate select
				players.forEach((p) => {
					const opt = document.createElement("option");
					opt.value = p;
					opt.text = p;
					select.appendChild(opt);
				});

				// Initialize Choices.js
				const choices = new Choices(select, {
					removeItemButton: true,
					searchEnabled: true,
					placeholderValue: "Select players...",
				});

				// Pre-select all players
				choices.setChoiceByValue(players);

				function getColor(i, total, highlight = false) {
					return highlight
						? `hsl(${(i / total) * 360}, 90%, 50%)`
						: `hsl(${(i / total) * 360}, 70%, 50%)`;
				}

				// Compute static top 3 from latest cumulative points
				const latestGW = Math.max(...data.map((d) => d.gw));
				const totals = players.map((p) => {
					const playerData = data.filter((d) => d.player === p);
					const last = playerData.find((d) => d.gw === latestGW);
					return { player: p, total: last ? last.cumulative : 0 };
				});
				totals.sort((a, b) => b.total - a.total);
				const top3 = totals.slice(0, 3).map((d) => d.player);

				// Prepare traces once
				const weeklyTraces = players.map((player, i) => {
					const pData = data.filter((d) => d.player === player);
					const isTop = top3.includes(player);
					return {
						x: pData.map((d) => d.gw),
						y: pData.map((d) => d.weekly),
						mode: "lines+markers",
						name: player,
						line: {
							color: getColor(i, players.length, isTop),
							width: isTop ? 4 : 1.5,
						},
						marker: { size: 6 },
					};
				});

				const cumTraces = players.map((player, i) => {
					const pData = data.filter((d) => d.player === player);
					const isTop = top3.includes(player);
					return {
						x: pData.map((d) => d.gw),
						y: pData.map((d) => d.cumulative),
						mode: "lines+markers",
						name: player,
						line: {
							color: getColor(i, players.length, isTop),
							width: isTop ? 4 : 1.5,
						},
						marker: { size: 6 },
					};
				});

				// Initial plots
				Plotly.newPlot("weekly-plot", weeklyTraces, {
					title: "Weekly Points",
				});
				Plotly.newPlot("cumulative-plot", cumTraces, {
					title: "Cumulative Points",
				});

				// Update visible lines on selection change
				function updateVisible() {
					const selected = choices.getValue(true);
					weeklyTraces.forEach((trace, i) => {
						Plotly.restyle(
							"weekly-plot",
							"visible",
							[
								selected.includes(trace.name)
									? true
									: "legendonly",
							],
							[i]
						);
					});
					cumTraces.forEach((trace, i) => {
						Plotly.restyle(
							"cumulative-plot",
							"visible",
							[
								selected.includes(trace.name)
									? true
									: "legendonly",
							],
							[i]
						);
					});
				}

				select.addEventListener("change", updateVisible);

				// Show all players initially
				updateVisible();
			}

			initDashboard();
		</script>
	</body>
</html>
